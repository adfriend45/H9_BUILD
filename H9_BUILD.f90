!=====================================================================!
PROGRAM H9_BUILD

!---------------------------------------------------------------------!
! Use this code to build the approaches to be used in HYBRID9.
! First work up the soil hydrology for a single site.
! All quantities are positive upwards where relevant to conform to the
! CLM technical description Olesen et al. (2013) (e.g. Eqn. 7.79).
! O13 refers to Olesen et al. (2013).
!---------------------------------------------------------------------!
IMPLICIT NONE
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
INTEGER :: I ! Soil layer index (n).
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Integration timestep (s).
!---------------------------------------------------------------------!
!REAL :: dt = 86400.0 / 24.0
REAL :: dt = 1.0
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Number of soil layers (n).
!---------------------------------------------------------------------!
INTEGER, PARAMETER :: nlayers = 8
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Percentage sand, clay (%age).
!---------------------------------------------------------------------!
REAL, PARAMETER :: pc_sand = 33.0
REAL, PARAMETER :: pc_clay = 33.0
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Soil layer centre heights, positive upwards from surface (mm).
!---------------------------------------------------------------------!
REAL :: z (nlayers)
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Soil layer thickneses (mm).
!---------------------------------------------------------------------!
REAL :: dz (nlayers)
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Primary state variable is volumetric soil water content (mm^3 mm^-3).
!---------------------------------------------------------------------!
REAL :: theta (nlayers)
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Matric potentials in soil layers (mm).
!---------------------------------------------------------------------!
REAL :: psi (nlayers)
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Hydraulic conductivities at layer interfaces (mm s^-1).
!---------------------------------------------------------------------!
REAL :: k (nlayers)
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Water fluxes at layer interfaces, positive upwards (mm s-1).
! Index refers to bottom of layer.
!---------------------------------------------------------------------!
REAL :: q (nlayers)
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Time derivatives of thetas (mm^3 mm^-3 s^-1).
!---------------------------------------------------------------------!
REAL :: dtheta (nlayers)
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Timestep index.
!---------------------------------------------------------------------!
INTEGER :: iTIME
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Water infiltration into surface soil layer (mm s^-1).
!---------------------------------------------------------------------!
REAL :: q_infl
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Saturated matric potential (mm).
!---------------------------------------------------------------------!
REAL :: psi_sat
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Saturated water content (mm).
!---------------------------------------------------------------------!
REAL :: theta_sat
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Saturated hydraulic conductivity (mm s^-1).
!---------------------------------------------------------------------!
REAL :: k_sat
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Clapp and Hornberger (1978) parameter.
!---------------------------------------------------------------------!
REAL :: B
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Water saturation fraction (fraction).
!---------------------------------------------------------------------!
REAL :: wv
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
WRITE (*,*) 'Starting...'
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Define soil layer centre heights, positive upwards from surface (mm).
! Also compute layer thicknesses (mm).
!---------------------------------------------------------------------!
z (1) = -50.0
dz (1) = -z (1) * 2.0
!---------------------------------------------------------------------!
DO I = 2, nlayers
  z (I) = z (I-1) - 50.0
  dz (I) = 2.0 * 50.0
END DO
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Saturated matric potential from Eqn. 7.96 of O13.
! (mm).
!---------------------------------------------------------------------!
psi_sat = -10.0 * 10.0 ** (1.88 - 0.0131 * pc_sand)
!---------------------------------------------------------------------!
write (*,*) psi_sat

!---------------------------------------------------------------------!
! Water content at saturation from Eqn. 7.91 of O13 (mm).
!---------------------------------------------------------------------!
theta_sat = 0.489 - 0.00126 * pc_sand
!---------------------------------------------------------------------!
write (*,*) theta_sat

!---------------------------------------------------------------------!
! Saturated hydraulic conductivity from Eqn. 7.99 of O13 (mm s-1).
!---------------------------------------------------------------------!
k_sat = 0.0070556 * 10.0 ** (-0.884 + 0.0153 * pc_sand)
!---------------------------------------------------------------------!
write (*,*) k_sat

!---------------------------------------------------------------------!
! Clapp and Hornberger parameter from Eqn. 7.93 of O13.
!---------------------------------------------------------------------!
B = 2.91 + 0.159 * pc_clay
!---------------------------------------------------------------------!
write (*,*) B

!---------------------------------------------------------------------!
! Initialise thetas (mm^3 mm^-3).
!---------------------------------------------------------------------!
theta (:) = 0.0
!---------------------------------------------------------------------!

DO iTIME = 1, 10

!---------------------------------------------------------------------!
! Hydraulic conductivities at layer interfaces from Eqn. 7.89 of O13
! (mm s^-1).
!---------------------------------------------------------------------!
DO I = 1, nlayers - 1
  k (I) = k_sat * (0.5 * (theta (I) + theta (I+1)) / theta_sat) &
          ** (2.0 * B + 3.0)
END DO
write (*,*) 'k'
write (*,*) k
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Matric potentials in soil layers [with gravi for now] (mm).
!---------------------------------------------------------------------!
DO I = 1, nlayers
  wv = theta (I) / theta_sat
  wv = MAX (0.01, wv)
  wv = MIN (1.0, wv)
  ! Eqn. 7.94 of O13.
  psi (I) = psi_sat * wv ** -B
  psi (I) = MAX (-1.0E8, psi (I)) + z (I)
END DO
write (*,*) 'psi'
write (*,*) psi
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Water infiltration into surface soil layer (mm s^-1).
!---------------------------------------------------------------------!
q_infl = 1.0 / dt
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Loop over soil layers to compute water fluxes at layer interfaces.
! Index refers to bottom of layer. Positive upwards.
! Based on Eqn. 7.116 of O13.
!---------------------------------------------------------------------!
DO I = 1, nlayers - 1
  q (I) = -k (I) * (psi (I) - psi (I+1)) / (z (I+1) - z (I))
END DO
q (nlayers) = 0.0 ! No drainage.
write (*,*) 'q'
write (*,*) q
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Loop over soil layers to adjust fluxes.
!---------------------------------------------------------------------!
dtheta (1) = (q_infl + q (1)) / dz (1)
DO I = 2, nlayers
  dtheta (I) = (q (I) - q (I-1)) / dz (I)
END DO
write (*,*) 'dtheta'
write (*,*) dtheta
!---------------------------------------------------------------------!

!---------------------------------------------------------------------!
! Loop over soil layers to apply fluxes.
!---------------------------------------------------------------------!
DO I = 1, nlayers
  theta (I) = theta (I) + dt * dtheta (I)
END DO
!---------------------------------------------------------------------!
write (*,*) 'theta'
write (*,*) theta

END DO ! Time loop.

!---------------------------------------------------------------------!
END PROGRAM H9_BUILD
!=====================================================================!
